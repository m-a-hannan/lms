name: LMS CD

on:
  workflow_run:
    workflows: ["LMS CI"]
    branches: ["main"]
    types:
      - completed

concurrency:
  group: lms-deploy-main
  cancel-in-progress: false

jobs:
  deploy-to-proxmox-vm:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - name: Checkout code (clean)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true

      - name: Capture commit info for logs/UI
        run: |
          set -e
          echo "GITHUB_SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_ENV
          echo "GITHUB_COMMIT_MESSAGE<<EOF" >> $GITHUB_ENV
          git log -1 --pretty=%B >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Show commit being deployed
        run: |
          set -e
          echo "Deploying commit: $GITHUB_SHA"
          git log -1 --oneline

      - name: Deploy files to Apache folder (keep server .env)
        run: |
          set -euo pipefail

          TARGET="/var/www/html"
          STAGE="/tmp/lms-deploy-$GITHUB_SHA"

          echo "Creating staging dir: $STAGE"
          rm -rf "$STAGE"
          mkdir -p "$STAGE"

          echo "Copy repo to staging..."
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".env" \
            --exclude "app/includes/config.php" \
            ./ "$STAGE/"

          echo "Writing deploy markers..."
          echo "$GITHUB_SHA" > "$STAGE/DEPLOYED_SHA.txt"
          date -Is > "$STAGE/DEPLOYED_AT.txt"

          echo "Creating target folder if missing..."
          sudo mkdir -p "$TARGET"

          echo "Rsync staging -> target..."
          sudo rsync -a --delete-delay \
            --exclude-from ".gitignore" \
            --exclude ".env" \
            --exclude "app/includes/config.php" \
            "$STAGE/" "$TARGET/"

          echo "Fix ownership to www-data..."
          sudo chown -R www-data:www-data "$TARGET"

          echo "Done deploying."

      - name: Restore DB (drop & recreate & import latest dump)
        run: |
          set -euo pipefail
          sudo /usr/local/sbin/lms-restore-db

      - name: Reload Apache
        run: |
          set -e
          sudo systemctl reload apache2
          echo "Apache reloaded."

      - name: Verify deployed version
        run: |
          set -e
          echo "Deployed SHA on server:"
          sudo cat /var/www/html/DEPLOYED_SHA.txt || true
          echo "Deployed time on server:"
          sudo cat /var/www/html/DEPLOYED_AT.txt || true
          echo "Deploy status JSON:"
          sudo cat /var/www/html/deploy/status.json || true
